{"version":3,"file":"unified.mjs","sources":["../../../../src/codecs/metadata/unified.ts"],"sourcesContent":["import { CodecType } from \"scale-ts\"\nimport { V14Lookup } from \"./lookup\"\nimport { storageMap } from \"./pallets\"\nimport { HexString } from \"../scale\"\nimport { itemDeprecation, variantDeprecation } from \"./deprecation\"\nimport { viewFunction } from \"./runtime-api\"\nimport { V14 } from \"./v14\"\nimport { V16 } from \"./v16\"\nimport { V15 } from \"./v15\"\nimport { Metadata } from \"./metadata\"\n\ntype EnumRef<T> =\n  | ({\n      type: number\n    } & (T extends 16\n      ? { deprecationInfo: CodecType<typeof variantDeprecation> }\n      : {}))\n  | undefined\n\ntype DeprecationInfo<T> = T extends 16\n  ? { deprecationInfo: CodecType<typeof itemDeprecation> }\n  : {}\n\nexport type UnifiedMetadata<T extends 14 | 15 | 16 = 14 | 15 | 16> = {\n  version: T\n  lookup: V14Lookup\n  pallets: Array<\n    {\n      name: string\n      storage:\n        | {\n            prefix: string\n            items: Array<\n              {\n                name: string\n                modifier: number\n                type:\n                  | { tag: \"plain\"; value: number }\n                  | { tag: \"map\"; value: CodecType<typeof storageMap> }\n                fallback: HexString\n                docs: string[]\n              } & DeprecationInfo<T>\n            >\n          }\n        | undefined\n      calls: EnumRef<T>\n      events: EnumRef<T>\n      constants: Array<\n        {\n          name: string\n          type: number\n          value: HexString\n          docs: string[]\n        } & DeprecationInfo<T>\n      >\n      errors: EnumRef<T>\n      associatedTypes: Array<{\n        name: string\n        type: number\n        docs: string[]\n      }>\n      viewFns: Array<CodecType<typeof viewFunction>>\n      index: number\n      docs: string[]\n    } & DeprecationInfo<T>\n  >\n  extrinsic: {\n    version: number[]\n    signedExtensions: Array<{\n      identifier: string\n      type: number\n      additionalSigned: number\n    }>\n  } & (T extends 14\n    ? {\n        type: number\n      }\n    : { address: number; call: number; signature: number }) &\n    (T extends 16\n      ? { signedExtensionsByVersion: Array<[number, number[]]> }\n      : {})\n  apis: Array<\n    {\n      name: string\n      methods: Array<\n        {\n          name: string\n          inputs: Array<{ name: string; type: number }>\n          output: number\n          docs: string[]\n        } & DeprecationInfo<T>\n      >\n      docs: string[]\n    } & (T extends 16 ? { version: number } : {}) &\n      DeprecationInfo<T>\n  >\n} & (T extends 14\n  ? {}\n  : {\n      outerEnums: { call: number; event: number; error: number }\n      custom: Array<[string, { type: number; value: HexString }]>\n    })\n\nexport const unifyMetadata = (\n  metadata: Metadata | Metadata[\"metadata\"] | V14 | V15 | V16,\n): UnifiedMetadata => {\n  // complete metadata\n  if (\"magicNumber\" in metadata) metadata = metadata.metadata\n  if (\"tag\" in metadata) {\n    if (\n      metadata.tag !== \"v14\" &&\n      metadata.tag !== \"v15\" &&\n      metadata.tag !== \"v16\"\n    )\n      throw new Error(\"Only metadata 14, 15, and 16 are supported\")\n    metadata = metadata.value\n  }\n\n  // v16\n  if (\"signedExtensionsByVersion\" in metadata.extrinsic) {\n    return { version: 16, ...(metadata as V16) }\n  }\n  // v15\n  if (\"custom\" in metadata) {\n    const { lookup, extrinsic, custom, apis, pallets, outerEnums } =\n      metadata as V15\n\n    return {\n      version: 15,\n      lookup,\n      pallets: pallets.map((p): UnifiedMetadata<15>[\"pallets\"][number] => ({\n        ...p,\n        calls: p.calls != null ? { type: p.calls } : undefined,\n        events: p.events != null ? { type: p.events } : undefined,\n        errors: p.errors != null ? { type: p.errors } : undefined,\n        viewFns: [],\n        associatedTypes: [],\n      })),\n      extrinsic: { ...extrinsic, version: [extrinsic.version] },\n      apis,\n      outerEnums,\n      custom,\n    }\n  }\n  // fallback, v14\n  const { lookup, extrinsic, pallets } = metadata as V14\n  return {\n    version: 14,\n    lookup,\n    pallets: pallets.map((p): UnifiedMetadata<14>[\"pallets\"][number] => ({\n      ...p,\n      calls: p.calls != null ? { type: p.calls } : undefined,\n      events: p.events != null ? { type: p.events } : undefined,\n      errors: p.errors != null ? { type: p.errors } : undefined,\n      viewFns: [],\n      associatedTypes: [],\n    })),\n    extrinsic: { ...extrinsic, version: [extrinsic.version] },\n    apis: [],\n  }\n}\n"],"names":["lookup","extrinsic","pallets"],"mappings":"AAuGa,MAAA,aAAA,GAAgB,CAC3B,QACoB,KAAA;AAEpB,EAAI,IAAA,aAAA,IAAiB,QAAU,EAAA,QAAA,GAAW,QAAS,CAAA,QAAA;AACnD,EAAA,IAAI,SAAS,QAAU,EAAA;AACrB,IAAA,IACE,SAAS,GAAQ,KAAA,KAAA,IACjB,SAAS,GAAQ,KAAA,KAAA,IACjB,SAAS,GAAQ,KAAA,KAAA;AAEjB,MAAM,MAAA,IAAI,MAAM,4CAA4C,CAAA;AAC9D,IAAA,QAAA,GAAW,QAAS,CAAA,KAAA;AAAA;AAItB,EAAI,IAAA,2BAAA,IAA+B,SAAS,SAAW,EAAA;AACrD,IAAA,OAAO,EAAE,OAAA,EAAS,EAAI,EAAA,GAAI,QAAiB,EAAA;AAAA;AAG7C,EAAA,IAAI,YAAY,QAAU,EAAA;AACxB,IAAM,MAAA,EAAE,MAAAA,EAAAA,OAAAA,EAAQ,SAAAC,EAAAA,UAAAA,EAAW,QAAQ,IAAM,EAAA,OAAA,EAAAC,QAAS,EAAA,UAAA,EAChD,GAAA,QAAA;AAEF,IAAO,OAAA;AAAA,MACL,OAAS,EAAA,EAAA;AAAA,MACT,MAAAF,EAAAA,OAAAA;AAAA,MACA,OAASE,EAAAA,QAAAA,CAAQ,GAAI,CAAA,CAAC,CAA+C,MAAA;AAAA,QACnE,GAAG,CAAA;AAAA,QACH,KAAA,EAAO,EAAE,KAAS,IAAA,IAAA,GAAO,EAAE,IAAM,EAAA,CAAA,CAAE,OAAU,GAAA,MAAA;AAAA,QAC7C,MAAA,EAAQ,EAAE,MAAU,IAAA,IAAA,GAAO,EAAE,IAAM,EAAA,CAAA,CAAE,QAAW,GAAA,MAAA;AAAA,QAChD,MAAA,EAAQ,EAAE,MAAU,IAAA,IAAA,GAAO,EAAE,IAAM,EAAA,CAAA,CAAE,QAAW,GAAA,MAAA;AAAA,QAChD,SAAS,EAAC;AAAA,QACV,iBAAiB;AAAC,OAClB,CAAA,CAAA;AAAA,MACF,SAAA,EAAW,EAAE,GAAGD,UAAAA,EAAW,SAAS,CAACA,UAAAA,CAAU,OAAO,CAAE,EAAA;AAAA,MACxD,IAAA;AAAA,MACA,UAAA;AAAA,MACA;AAAA,KACF;AAAA;AAGF,EAAA,MAAM,EAAE,MAAA,EAAQ,SAAW,EAAA,OAAA,EAAY,GAAA,QAAA;AACvC,EAAO,OAAA;AAAA,IACL,OAAS,EAAA,EAAA;AAAA,IACT,MAAA;AAAA,IACA,OAAS,EAAA,OAAA,CAAQ,GAAI,CAAA,CAAC,CAA+C,MAAA;AAAA,MACnE,GAAG,CAAA;AAAA,MACH,KAAA,EAAO,EAAE,KAAS,IAAA,IAAA,GAAO,EAAE,IAAM,EAAA,CAAA,CAAE,OAAU,GAAA,MAAA;AAAA,MAC7C,MAAA,EAAQ,EAAE,MAAU,IAAA,IAAA,GAAO,EAAE,IAAM,EAAA,CAAA,CAAE,QAAW,GAAA,MAAA;AAAA,MAChD,MAAA,EAAQ,EAAE,MAAU,IAAA,IAAA,GAAO,EAAE,IAAM,EAAA,CAAA,CAAE,QAAW,GAAA,MAAA;AAAA,MAChD,SAAS,EAAC;AAAA,MACV,iBAAiB;AAAC,KAClB,CAAA,CAAA;AAAA,IACF,SAAA,EAAW,EAAE,GAAG,SAAA,EAAW,SAAS,CAAC,SAAA,CAAU,OAAO,CAAE,EAAA;AAAA,IACxD,MAAM;AAAC,GACT;AACF;;;;"}